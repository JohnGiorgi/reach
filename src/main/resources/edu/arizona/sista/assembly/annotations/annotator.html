<html>
  <head>
    <title>Assembly Annotations</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>
      .table td {
        text-align: center;
      }
      .legend {
        color: grey;
      }
      #relation {
        font-size: x-large;
      }
      .example {
        font-size: 125%;
      }
      .more-margin {
        margin-top: 2em;
      }
      .big-margin {
        margin-top: 4em;
      }
      .event-text {
        color: grey;
      }
      .e1 {
        color: dodgerblue;
      }
      .e2 {
        color: red;
      }
    </style>
    <!-- bootstrap -->
    <link rel="stylesheet" href="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css">
    <!-- jquery -->
    <script src="https://code.jquery.com/jquery-2.2.2.min.js"></script>
    <!-- more bootstrap -->
    <script src="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js"></script>
    <!-- local storage -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-cookie/1.4.1/jquery.cookie.js"></script>
    <!-- underscore -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.8.3/underscore.js"></script>
  </head>
  <body>
    <div class="container theme-showcase" role="main">
      <script>
        $(document).ready(function() {

          var annotations = [];
          var current = 0;

          // load json
          $.getJSON("annotations.json", function(json) {
              annotations = json;
              console.log("annotations: " + annotations);
              // update the displayed data
              updateTable();
              console.log("annotations: " + annotations.length);
              console.log("updated table!")
            });

          // handle data export
          $("#export").click(function() {
            var dataURI = encodeURIComponent(JSON.stringify(annotations, null, '\t'));
            var data = "text/json;charset=utf-8," + dataURI;
            var annoID = $("#annotator-id").val();
            var a = document.createElement('a');
            a.href = 'data:' + data;
            a.download = 'annotations-'+ annoID + '.json';
            // TODO: is there a way to open this in a new window client-side?
            window.location.href = a
          });

          // update stored annotation
          function updateAnnotation() {
            var anno = annotations[current];
            var label = $("#relation").text();
            var annoID = $("#annotator-id").val();
            anno["relation"] = label;
            anno["annotator-id"] = annoID
          }

          function getPaperLink(anno) {
            var pmid = anno["paper-id"];
            var url = "http://www.ncbi.nlm.nih.gov/pmc/articles/" + pmid;
            return "<a href=\"" + url + "\" target=\"_blank\">" + pmid + "</a>"
          }

          function getSentences(anno) {
            // e1
            var e1Toks = anno["e1-tokens"];
            var e1Start = anno["e1-start"];
            var e1End = anno["e1-end"];
            var e1TriggerStart = anno["e1-trigger-start"];
            var e1TriggerEnd = anno["e1-trigger-end"] - 1;

            // format trigger for e1
            var e1tStart = e1Toks[e1TriggerStart];
            e1Toks[e1TriggerStart] = "<strong>" + e1tStart;
            var e1tEnd = e1Toks[e1TriggerEnd];
            e1Toks[e1TriggerEnd] = e1tEnd + "</strong>";

            // e2
            var e2Toks = anno["e2-tokens"];
            var e2Start = anno["e2-start"];
            var e2End = anno["e2-end"];
            var e2TriggerStart = anno["e2-trigger-start"];
            var e2TriggerEnd = anno["e2-trigger-end"]  - 1;

            // format trigger for e2
            var e2tStart = e2Toks[e2TriggerStart];
            e2Toks[e2TriggerStart] = "<strong>" + e2tStart;
            var e2tEnd = e2Toks[e2TriggerEnd];
            e2Toks[e2TriggerEnd] = e2tEnd + "</strong>";

            // format the event text
            var endTag = "</span> ";
            var e1Text = "<span class='event-text'>" + e1Toks.slice(0, e1Start).join(" ") + " <span class ='e1'>" + e1Toks.slice(e1Start, e1End).join(" ") + endTag + e1Toks.slice(e1End, e1Toks.length).join(" ") + endTag;
            var e2Text = "<span class='event-text'>" + e2Toks.slice(0, e2Start).join(" ") + " <span class ='e2'>" + e2Toks.slice(e2Start, e2End).join(" ") + endTag + e2Toks.slice(e2End, e2Toks.length).join(" ") + endTag;
            return {
              "e1Sent": e1Text,
              "e2Sent": e2Text
            }
          }
          // update displayed information
          function updateTable() {
            var anno = annotations[current];
            var text = getSentences(anno);
            // get event labels
            var e1Label = anno["e1-label"];
            var e2Label = anno["e2-label"];
            // relation label
            var label = anno["relation"];
            // paper link
            var paperLink = getPaperLink(anno);
            // update displayed sentences
            $("#e1-text").html(text.e1Sent);
            $("#e2-text").html(text.e2Sent);
            // update labels for events
            $("#e1-label").html("<code>" + e1Label + "</code>");
            $("#e2-label").html("<code>" + e2Label + "</code>");
            // update relation
            $("#relation").text(label);
            // update paper link
            $("#paper").html(paperLink);
            // update displayed information
            var total = annotations.length;
            $("#total").text(current + 1 + " / " + total);
          }

          // reset displayed values
          function clearTable() {
            console.log("\tClearing table!");
            $("#e1-text").text("");
            $("#e2-text").text("");
            // clear relation and label
            $("#relation").text("");
            // don't remove annotator id
          }

          // store and reset displayed values
          function storeAndClearTable() {
            updateAnnotation();
            clearTable()
          }

          // move to the next training instance
          function advanceCurrent() {
            var next = current + 1;
            if (next < annotations.length) {
              current = next
            } else current = 0
          }

          // move to the previous training instance
          function retreatCurrent() {
            var prev = current - 1;
            var last = annotations.length - 1;
            if ((prev >= 0) && (prev <= annotations.length)) {
              current = prev
            } else if (prev < 0) {
              current = last
            }
          }

          // handle navigation
          $(document).keydown(function(e) {
            // only perform action if button is pressed outside of text area
            var tag = e.target.tagName.toLowerCase();
            if (tag != 'input' && tag != 'textarea') {
              // relations via number keys
              if (e.which == 49) {
                var v = 'None';
                $("#relation").text(v);
                updateAnnotation();
              }
              if (e.which == 50) {
                var v = 'E1 precedes E2';
                $("#relation").text(v);
                updateAnnotation();
              }
              if (e.which == 51) {
                var v = 'E2 precedes E1';
                $("#relation").text(v);
                updateAnnotation();
              }
              if (e.which == 52) {
                var v = 'Equivalent';
                $("#relation").text(v);
                updateAnnotation();
              }
              if (e.which == 53) {
                var v = 'E1 subsumes E2';
                $("#relation").text(v);
                updateAnnotation();
              }
              if (e.which == 54) {
                var v = 'E2 subsumes E1';
                $("#relation").text(v);
                updateAnnotation();
              }
              // arrows
              if (e.which == 37) {
                storeAndClearTable();
                retreatCurrent();
              }
              if (e.which == 39) {
                storeAndClearTable();
                advanceCurrent();
              }
              updateTable()
            }
          });
        });
      </script>
      <table class="table table-hover">
        <thead>
          <tr>
            <th class="text-center h3"><span class="e1">E1</span></th>
            <th class="text-center h3"><span class="e2">E2</span></th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td id="e1-label" class="text-center example"></td>
            <td id="e2-label" class="text-center example"></td>
          </tr>
          <tr>
            <td id="e1-text" class="text-center example"></td>
            <td id="e2-text" class="text-center example"></td>
          </tr>
        </tbody>
      </table>
      <!-- selection -->
      <div class="container big-margin">
        <!-- relation selector -->
        <div class="form-group row">
          <label class="control-label col-sm-2 h4" for="annotator-id">Annotator ID:</label>
          <div class="col-sm-3">
            <input type="text" class="form-control" id="annotator-id" placeholder="Enter annotator id (email)">
          </div>
        </div>
        <!-- relation selector -->
        <div class="form-group row">
          <label class="control-label col-sm-2 h4" for="relation">Relation:</label>
          <div class="col-sm-3">
            <div id="relation"></div>
          </div>
        </div>
        <!-- paper -->
        <div class="form-group row">
          <label class="control-label col-sm-2 h4" for="relation">Paper:</label>
          <div class="col-sm-3">
            <div id="paper" class="h4"></div>
          </div>
        </div>
        <!-- count and annotation export -->
        <div class="form-group row">
          <label id="total" class="control-label col-sm-2 h4" for="export"></label>
          <div class="col-sm-3">
            <button id="export"class="btn btn-primary"  data-toggle="tooltip" data-placement="right" title="Export annotations to .json">Export</button>
          </div>
        </div>
      </div>
      <hr>
      <!-- Examples -->
      <button type="button" class="btn btn-info" data-toggle="collapse" data-target="#examples">Examples</button>
      <div id="examples" class="collapse">
        <p class="more-margin">
          Choose the most appropriate relation that holds between the two events.  If the relation is unclear or nonexistent, choose <b>None</b>.
        </p>
        <table class="table table-striped legend">
          <thead>
            <tr>
              <th class="text-center h4">E1</th>
              <th class="text-center h4">E2</th>
              <th class="text-center h4">Relation</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td class="text-center">Protein A is phosphorylated by Protein B.</td>
              <td class="text-center">Following its phosphoyrlation, Protein A is bound to Protein C.</td>
              <td class="text-center">E1 precedes E2</td>
            </tr>
            <tr>
              <td class="text-center">Protein A is phosphorylated by Protein B.</td>
              <td class="text-center">Protein C binds with Protein D.</td>
              <td class="text-center">None</td>
            </tr>
            <tr>
              <td class="text-center">Protein A is phosphorylated by Protein B.</td>
              <td class="text-center">The phosphoyrlation of Protein A by Protein B leads to ...</td>
              <td class="text-center">Equivalent</td>
            </tr>
          </tbody>
        </table>
      </div>
      <!-- key legend -->
      <div class="legend">
        <div class="col-xs-6">
          <h3 class="sub-header text-center">Relations</h3>
            <div class="table-responsive">
              <table class="table legend">
                <thead>
                  <tr>
                    <th class="col-md-2">Key</th>
                    <th class="col-md-2">Action</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td class="col-md-2">1</td>
                    <td class="col-md-2">None</td>
                  </tr>
                  <tr>
                    <td class="col-md-2">2</td>
                    <td class="col-md-2">E1 precedes E2</td>
                  </tr>
                  <tr>
                    <td class="col-md-2">3</td>
                    <td class="col-md-2">E2 precedes E1</td>
                  </tr>
                  <tr>
                    <td class="col-md-2">4</td>
                    <td class="col-md-2">Equivalent</td>
                  </tr>
                   <tr>
                    <td class="col-md-2">5</td>
                    <td class="col-md-2">E1 subsumes E2</td>
                  </tr>
                  <tr>
                   <td class="col-md-2">6</td>
                   <td class="col-md-2">E2 subsumes E1</td>
                 </tr>
                </tbody>
              </table>
            </div>
        </div>
        <div class="col-xs-6">
          <h3 class="sub-header text-center">Navigation</h3>
          <div class="table-responsive">
            <table class="table legend">
              <thead>
                <tr>
                  <th class="col-md-2">Key</th>
                  <th class="col-md-2">Action</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td class="col-md-2">&larr;</td>
                  <td class="col-md-2">previous annotation</td>
                </tr>
                <tr>
                  <td class="col-md-2">&rarr;</td>
                  <td class="col-md-2">next annotation</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
      <!-- end of legend -->
    </div>
  </body>
</html>
