#########
# Modification triggers
#########

# NOTE: This used to start with (?<! [lemma=/^have$/ & !tag="MD"]) but I don't think ODIN supports multiple lookarounds
- name: modification_trigger_1
  label: [ModificationTrigger]
  priority: 1
  type: token
  action: mkModTrigger
  pattern: |
    (?<mod>[!lemma=/^(un|de|non)/ & lemma=/(?i)phosphorylat|ubiquitinat|acetylat|farnesylat|glycosylat|hydroxylat|methylat|ribosylat|sumoylat/ & !outgoing=/prep_by|agent/ & tag=/^(JJ|VBN)/]) @BioChemicalEntity (?! [lemma=/^(fragment|protein)/]? [lemma="by"] @BioChemicalEntity)

- name: modification_trigger_2
  label: [ModificationTrigger]
  priority: 1
  type: token
  pattern: |
    (^[!lemma=/^(un|de|non)/ & lemma=/(?i)phosphorylat|ubiquitinat|acetylat|farnesylat|glycosylat|hydroxylat|methylat|ribosylat|sumoylat/ & !outgoing=/prep_by|agent/ & tag=/^NN/]) (?! [lemma="by"] @BioChemicalEntity)

#########
# Modification rules
#########

# Phosphorylated p53 on serine-15
- name: PTMmodification_1
  label: [PTM, Modification, BioChemicalEntity]
  action: mkModification
  priority: 2
  type: token
  pattern: |
    @mod:ModificationTrigger @entity:BioChemicalEntity ([tag=/^N/ & !mention=/./]*? [tag=IN] @site:Site)?

- name: eventsite_1
  label: [EventSite, Modification, BioChemicalEntity]
  action: storeEventSite
  priority: 2
  type: token
  pattern: |
    @site:Site "of" @entity:BioChemicalEntity

# ex. "phosphorylation on the JM domains of EGFR and HER2"
# should create EGFR(Mods = EventSite(JM domains)), HER2(Mods = EventSite(JM domains))
- name: eventsite_multisite_1
  label: [EventSite, Modification, BioChemicalEntity]
  action: storeEventSite
  priority: 2
  type: token
  pattern: |
    # handles "Experiments revealed ubiquitination at Lys residues 117, 147, and 170 for H-Ras."
    @site:Site [!tag=/^V/ & !word=/phosph|ubiq|farne|acetyl|glycosyl|hydroxyl|ribosyl|sumosyl|methyl/]*? /^(of|on|for)/ /./*? @entity:BioChemicalEntity
    |
    @entity:BioChemicalEntity /^(of|on)/ @site:Site+
    |
    [!mention=ModificationTrigger] @entity:BioChemicalEntity [lemma=/^(residue)/]? [!word=/phosph|ubiq|farne|acetyl|glycosyl|hydroxyl|ribosyl|sumosyl|methyl/]{,4} @site:Site
    | # "EGFR and ERBB3 tyrosine phosphorylation that ..."
    @entity:BioChemicalEntity [!tag=/^V/ & !lemma="of"]{,4}? @site:Site [word=/phosph|ubiq|farne|acetyl|glycosyl|hydroxyl|ribosyl|sumosyl|methyl/ & tag=/^N/]


# this grabs all sites that it finds within parens
- name: eventsite_withparens
  label: [EventSite, Modification, BioChemicalEntity]
  action: storeEventSite
  priority: 2
  example: "ERK(T202/Y204)"
  type: token
  pattern: |
    @entity:BioChemicalEntity [word="("] /./*? @site:Site [word=")"]

# TODO: Add rule + action that adds some Site to multiple Entities
# Need to handle cases like "site1, site2, site3 of ENTITY" => as ENTITY with EventSite(site1), EventSite(site2), EventSite(site3)


##########
# Mutants
#########

- name: mutant_1
  label: [Mutant]
  priority: 1
  type: token
  action: mkEntities
  keep: false
  pattern: |
    [lemma=/^(mutant)/]? (?<entity>[word=/(?i)^[ACDEFGHIKLMNQRSTVWY]\d+[ACDEFGHIKLMNPQRSTVWY]$/]) [lemma=/^(mutant)/]?

- name: mutant_2
  label: [Mutant]
  priority: 1
  type: token
  action: mkEntities
  keep: false
  pattern: |
    [lemma=/^(mutant)/]? (?<entity>[word=/^P\d+[ACDEFGHIKLMNPQRSTVWYacdefghiklmnpqrstvwy]$/]) [lemma=/^(mutant)/]?

- name: mutant_3
  label: [Mutant]
  priority: 1
  type: token
  action: mkEntities
  keep: false
  pattern: |
    [lemma=/^(mutant)/]? (?<entity>[word=/(?i)^(Ala|Arg|Asn|Asp|Cys|Gln|Glu|Gly|His|Ile|Leu|Lys|Met|Phe|Pro|Ser|Thr|Trp|Tyr|Val)\d+(Ala|Arg|Asn|Asp|Cys|Gln|Glu|Gly|His|Ile|Leu|Lys|Met|Phe|Pro|Ser|Thr|Trp|Tyr|Val)$/]) [lemma=/^(mutant)/]?

#NOTE: mutant_4 should happen AFTER mutant_1 - mutant_3
- name: mutant_4
  label: [Mutant]
  priority: 2
  type: token
  keep: false
  pattern: |
    (?<= [mention=BioChemicalEntity]) [lemma=/^(mutant)/ & !mention=Mutant] (?! [mention=Mutant])

#NOTE: mutant_5 should happen AFTER mutant_1 - mutant_3
- name: mutant_5
  label: [Mutant]
  priority: 2
  type: token
  keep: false
  pattern: |
    (?<! [mention=Mutant]) [lemma=/^(mutant)/ & !mention=Mutant] (?= [mention=BioChemicalEntity])

##########
# Store Mutant mods
#########

- name: mutantmod_1
  label: [MutantMod, Modification]
  action: storeMutants
  priority: 3
  type: token
  pattern: |
    [lemma=/^(mutant)/]? @entity:BioChemicalEntity [lemma=/^(mutant)/]? @mutant:Mutant [lemma=/^(mutant)/]?
    |
    @mutant:Mutant [lemma=/^(mutant)/]? @entity:BioChemicalEntity [lemma=/^(mutant)/]?

- name: mutantmod_2
  label: [MutantMod, Modification]
  action: storeMutants
  priority: 3
  type: token
  pattern: |
    (?<! [mention=BioChemicalEntity]) @mutant:Mutant [!tag=/^(V|CC)/]{,5} [tag="CC"] @Mutant [lemma=/^(mutant)/]? @entity:BioChemicalEntity

- name: mutantmod_3
  label: [MutantMod, Modification]
  example: "ASPP1 mutants K111M, K112M, and K113M and ASPP2"
  action: storeMutants
  priority: 3
  type: token
  pattern: |
    @entity:BioChemicalEntity [lemma=/^(mutant)/]? @Mutant [!tag=/^(V|CC)/]{,5} [tag="CC"] @mutant:Mutant (?! [mention=BioChemicalEntity])

# this grabs all Mutants that it finds within parens
- name: mutantmod_withparens
  label: [MutantMod, Modification]
  action: storeMutants
  priority: 3
  example: "ERK(T202M/Y204E)"
  type: token
  pattern: |
    @entity:BioChemicalEntity [word="("] /./*? @mutant:Mutant [word=")"]


#- name: mutant_2
#  label: [Mutant] # This is currently not used.  It could be combined with labels on the "mutated" arg.
#  priority: 1
#  type: token
#  action: mkModification
#  pattern: |
#    (?<evidence>[word=/(?i)^[ACDEFGHIKLMNQRSTVWY]\d+[ACDEFGHIKLMNPQRSTVWY]?$/]) "and" /./{,4}? @mutated:BioChemicalEntity
#      |
#    (?<evidence>/^P\d+[ACDEFGHIKLMNPQRSTVWYacdefghiklmnpqrstvwy]?$/) "and" /./{,4}? @mutated:BioChemicalEntity