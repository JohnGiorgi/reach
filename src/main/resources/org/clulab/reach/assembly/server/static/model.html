<!DOCTYPE html>
<html lang="en">
<head>
    <title>Model Specification</title>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>
        .todo {
            background-color: yellow;
            font-weight: bold;
        }
        td {
            vertical-align: middle;
        }
    </style>
  <!-- bootstrap -->
  <link rel="stylesheet" href="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css">
  <!-- jquery -->
  <script src="https://code.jquery.com/jquery-2.2.2.min.js"></script>
  <!-- more bootstrap -->
  <script src="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js"></script>
  <!-- bootstrap dialog -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap3-dialog/1.34.7/css/bootstrap-dialog.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap3-dialog/1.34.7/js/bootstrap-dialog.min.js"></script>
  <!-- underscore -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.8.3/underscore.js"></script>
  <script type="text/javascript">
    $(document).ready(function() {

        // keep track of event IDs;
        var eventIDs = ["E1"];

        var removedIDs = {};

        function getNextID() {
            var nextID = "E" + (eventIDs.length + 1);
            eventIDs.push(nextID);
            //console.log("eventIDs: " + eventIDs);
            return nextID
        }

        $("#add").click(function() {
          $('#reactions tbody>tr:last').clone(true).insertAfter('#reactions tbody>tr:last');
          var nextID = getNextID();
          // update reaction ID
          $('#reactions tbody>tr:last #reaction').attr("id", nextID);
          // set text of ID
          $('#reactions tbody>tr:last #event-id').text(nextID);
          $('#reactions tbody>tr:last #controller').val('');
          $('#reactions tbody>tr:last #reaction-type').val('');
          $('#reactions tbody>tr:last #controlled').val('');
          $('#reactions tbody>tr:last #preceded-by').val('');
          return false;
        });

        $("#remove-reaction").click(function () {
            if ((eventIDs.length - Object.keys(removedIDs).length) > 1) {
                var toRemove = $(this).prev('#event-id').text();
                //console.log("Removed " + toRemove);
                removedIDs[toRemove] = true;
                //console.log("toRemove set: " + Object.keys(removedIDs).join(", "));
                $(this).closest('tr').remove();
            } else {
             //console.log("can't remove w/ eventIDs: " + eventIDs);
             alert("Cannot remove all reactions!");
            }
            return false;
        });

        $("#preceded-by").on("mouseenter", function () {
            //console.log("repopulating preceded-by");
            populatePredecessors(this);
            return false;
        });

        function populatePredecessors(predecessorsSelector) {
            // Find id of this event
            var currentEvent = $(predecessorsSelector).closest('tr').find('#event-id').text();
            //console.log("current event: " + currentEvent);
            // Filter possible selections
            // Disallow event to be preceded by itself
            var candidates = _.filter(eventIDs, function(event) {
                return (!(event in removedIDs) && (currentEvent != event));
            });
            // keep track of currently selected option
            var selected = $(predecessorsSelector).find(":selected");
            // empty options
            $(predecessorsSelector).empty();
            $(selected).appendTo(predecessorsSelector);
            $(predecessorsSelector).val(selected.val());
            // add default
            $("<option>").val("NONE").text("").appendTo(predecessorsSelector);
            // add each candidate
            $.each(candidates, function( i, candidate) {
                $("<option>").val(candidate).text(candidate).appendTo(predecessorsSelector);
            });
        }
    });
  </script>
</head>

<body>
  <div class="container theme-showcase" role="main">
      <!-- jumbotron -->
      <div class="jumbotron">
        <h1>Model specification</h1>
        <div>
          <p>Specify a model in terms of reactions.</p>
          <p><span class="todo">TODO: Export to tab-delimited model file</span></p>
          <p><span class="todo">TODO: Visualize model</span></p>
        </div>
      </div>
      <div class="container">
          <h3><a id="add">Add Reaction +</a></td></h3>
          <table id="reactions" width="300" border="1" cellspacing="0" cellpadding="2" class="table table-striped">
              <tbody>
              <tr>
                  <td><h3>Event ID</h3></td><td><h3>Controller</h3></td><td><h3>Reaction</h3></td><td><h3>Controlled</h3></td><td><h3>Preceded by</h3></td>
              </tr>
              <tr class="reaction">
                  <td>
                      <h3 id="event-id">E1</h3>
                      <button type="button" class="btn btn-danger" id="remove-reaction">Remove</button>
                  </td>
                  <!-- CONTROLLER -->
                  <td>
                      <div class="form-group">
                          <label for="controller">Controller</label>
                          <input class="form-control" type="text" name="controller" id="controller"/>
                      </div>
                      <div class="form-group">
                          <label for="controller-grounding-id">Grounding ID</label>
                          <!-- TODO: use ajax to retrieve grounding candidate ids-->
                          <select class="form-control" name="controller-grounding-id" id="controller-grounding-id">
                              <option value="unknown">???</option>
                          </select>
                      </div>
                      <!-- mods, mutant state, etc-->
                      <div class="form-group">
                          <label for="controller-state">State</label>
                          <div id="controller-state">
                              <div class="checkbox">
                                  <label><input type="checkbox" name="phosporylated" value="Phosphorylated">Phosphorylated</label>
                              </div>
                              <div class="checkbox">
                                  <label><input type="checkbox" name="bound" value="bound">Bound</label>
                              </div>
                              <div class="checkbox">
                                  <label><input type="checkbox" name="activated" value="activated">Activated</label>
                              </div>
                              <div class="checkbox">
                                  <label><input type="checkbox" name="deactivated" value="deactivated">Deactivated</label>
                              </div>
                              <div class="checkbox">
                                  <label><input type="checkbox" name="mutant" value="mutant">Mutant</label>
                              </div>
                          </div>
                      </div>
                  </td>
                  <!-- Reaction -->
                  <td>
                      <div class="form-group">
                          <label for="reaction-type">Reaction</label>
                          <select class="form-control" name="reaction-type" id="reaction-type">
                              <option value="NONE">???</option>
                              <option value="phosphorylation">Phosphorylates</option>
                              <option value="ubiquitination">Ubiquitinates</option>
                              <option value="binding">Binds</option>
                              <option value="positive-regulation">Upregulates</option>
                              <option value="negative-regulation">Downregulates</option>
                          </select>
                      </div>
                  </td>
                  <!-- CONTROLLED -->
                  <td>
                     <div class="form-group">
                        <label for="controlled">Controlled</label>
                        <input class="form-control" type="text" name="controlled" id="controlled"/>
                     </div>
                     <div class="form-group">
                        <label for="controlled-grounding-id">Grounding ID</label>
                        <!-- TODO: use ajax to retrieve grounding candidate ids-->
                        <select class="form-control" name="controlled-grounding-id" id="controlled-grounding-id">
                            <option value="unknown">???</option>
                        </select>
                     </div>
                  <!-- mods, mutant state, etc-->
                  <div class="form-group">
                      <label for="controlled-state">State</label>
                      <div id="controlled-state">
                      <div class="checkbox">
                          <label><input type="checkbox" name="phosporylated" value="Phosphorylated">Phosphorylated</label>
                      </div>
                      <div class="checkbox">
                          <label><input type="checkbox" name="bound" value="bound">Bound</label>
                      </div>
                      <div class="checkbox">
                          <label><input type="checkbox" name="activated" value="activated">Activated</label>
                      </div>
                      <div class="checkbox">
                          <label><input type="checkbox" name="deactivated" value="deactivated">Deactivated</label>
                      </div>
                      <div class="checkbox">
                          <label><input type="checkbox" name="mutant" value="mutant">Mutant</label>
                      </div>
                      </div>
                  </div>
                </td>
                <td>
                    <div class="form-group">
                        <label for="preceded-by">Preceded by</label>
                        <select class="form-control" name="preceded-by" id="preceded-by">
                            <option value="NONE"></option>
                        </select>
                    </div>
                </td>
              </tr>
              </tbody>
            </table>
      </div>
  </div>
</body>
</html>
